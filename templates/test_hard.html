{% extends "base.html" %}

{% block title %}í•˜ë“œ ëª¨ë“œ ({{ index }}/{{ total }}){% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto py-10 px-4">
    
    <div class="flex justify-between text-sm text-gray-500 mb-2 font-bold">
        <span>Question {{ index }}</span>
        <span>{{ total }}</span>
    </div>
    
    <div class="w-full h-3 bg-gray-200 rounded-full mb-8 overflow-hidden">
        <div class="h-full bg-red-500 transition-all duration-500" style="width: {{ ((index / total) * 100)|int }}%"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-lg border border-red-100 p-8 md:p-12 relative">
        
        <div class="text-center mb-10">
            <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded font-bold tracking-wider">HARD MODE</span>
            <h3 class="text-xl md:text-2xl font-bold text-gray-800 mt-6 leading-relaxed break-keep">
                "{{ question.meaning }}"
            </h3>
            <p class="text-gray-400 text-sm mt-3">ìœ„ ëœ»ì— í•´ë‹¹í•˜ëŠ” ë‹¨ì–´ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.</p>
        </div>

        <div class="max-w-md mx-auto">
            <input type="text" id="answer-input" 
                   class="w-full text-center text-2xl py-3 border-b-2 border-gray-300 focus:border-red-500 outline-none font-bold text-gray-800 placeholder-gray-300 transition-colors bg-transparent"
                   placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off"
                   onkeyup="if(window.event.keyCode==13){submitAnswer()}">
            
            <button id="submit-btn" onclick="submitAnswer()" class="w-full mt-8 bg-red-500 text-white text-lg font-bold py-3 rounded-xl shadow hover:bg-red-600 transition-transform transform active:scale-95">
                ì •ë‹µ ì œì¶œ
            </button>
        </div>

        <div id="next-area" class="hidden mt-8 text-center border-t border-gray-100 pt-6 animate-fade-in-up">
            <div id="feedback-msg" class="text-xl font-bold mb-4"></div>
            
            <div id="correct-display" class="hidden mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                <span class="text-gray-500 text-sm block mb-1">ì •ë‹µì€</span>
                <span class="text-green-600 font-bold text-2xl">{{ question.word }}</span>
            </div>
            
            <button onclick="location.reload()" id="next-btn" class="bg-gray-800 text-white px-10 py-3 rounded-xl font-bold hover:bg-gray-900 shadow-lg transition-colors">
                ë‹¤ìŒ ë¬¸ì œ â”
            </button>
        </div>
    </div>
</div>

<script>
    let solved = false;

    function submitAnswer() {
        if (solved) return;
        
        const input = document.getElementById('answer-input');
        const answer = input.value.trim();
        
        if(!answer) { 
            alert("ë‹µì„ ì…ë ¥í•˜ì„¸ìš”!"); 
            input.focus();
            return; 
        }
        
        solved = true;
        input.disabled = true;
        document.getElementById('submit-btn').classList.add('hidden');

        fetch('/test/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answer: answer })
        })
        .then(res => res.json())
        .then(data => {
            const feedback = document.getElementById('feedback-msg');
            const correctDisplay = document.getElementById('correct-display');
            const nextBtn = document.getElementById('next-btn');
            
            if (data.correct) {
                feedback.innerHTML = "ğŸ”¥ <span class='text-green-600'>ì™„ë²½í•©ë‹ˆë‹¤! ì •ë‹µì…ë‹ˆë‹¤!</span>";
                input.classList.add('text-green-600', 'border-green-500');
            } else {
                feedback.innerHTML = "ğŸ˜­ <span class='text-red-500'>í‹€ë ¸ìŠµë‹ˆë‹¤...</span>";
                input.classList.add('text-red-500', 'border-red-500', 'line-through');
                
                // APIê°€ ë³´ë‚´ì¤€ ì •ë‹µìœ¼ë¡œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                correctDisplay.querySelector('span.text-2xl').innerText = data.answer;
                correctDisplay.classList.remove('hidden');
            }
            
            document.getElementById('next-area').classList.remove('hidden');
            
            if (data.finished) {
                nextBtn.innerText = "ê²°ê³¼ í™•ì¸ â”";
                nextBtn.classList.remove('bg-gray-800', 'hover:bg-gray-900');
                nextBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                nextBtn.onclick = function() {
                    window.location.href = "/test/result";
                };
            }
            
            // ì—”í„°í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    document.getElementById('next-btn').click();
                }
            }, { once: true });
        })
        .catch(err => {
            console.error('Error:', err);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        });
    }
</script>

<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.3s ease-out forwards;
    }
</style>
{% endblock %}