{% extends "base.html" %} {% block title %}ê²Œì„ ìƒì„± - ê³¨ë“ ë²¨{% endblock %} {%
block content %}
<div class="max-w-6xl mx-auto py-12 px-4">
  <div class="text-center mb-10">
    <h2 class="text-4xl font-bold text-yellow-600 mb-3">ğŸ”” ê³¨ë“ ë²¨ ê²Œì„ ìƒì„±</h2>
    <p class="text-gray-600 text-lg">
      ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì—¬ ìƒˆë¡œìš´ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”
    </p>
  </div>

  {% if quiz_sets %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- ìƒˆ ë¬¸ì œì§‘ ì¶”ê°€ ë²„íŠ¼ -->
    <div
      class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-lg border-2 border-green-200 hover:border-green-400 hover:shadow-2xl transition-all duration-300 overflow-hidden group cursor-pointer"
      onclick="openAddQuizModal()"
    >
      <div
        class="p-6 h-full flex flex-col items-center justify-center min-h-[200px]"
      >
        <div class="text-6xl mb-4 group-hover:scale-110 transition-transform">
          â•
        </div>
        <h3
          class="text-xl font-bold text-green-700 group-hover:text-green-800 transition-colors"
        >
          ìƒˆ ë¬¸ì œì§‘ ì¶”ê°€
        </h3>
        <p class="text-sm text-green-600 mt-2">ì§ì ‘ ë¬¸ì œì§‘ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
      </div>
    </div>

    {% for quiz in quiz_sets %}
    <div
      class="bg-white rounded-2xl shadow-lg border-2 border-yellow-50 hover:border-yellow-400 hover:shadow-2xl transition-all duration-300 overflow-hidden group cursor-pointer"
      onclick="selectQuiz('{{ quiz.id }}', '{{ quiz.name }}')"
    >
      <div class="p-6">
        <div class="flex items-start justify-between mb-3">
          <div class="flex-1">
            <h3
              class="text-xl font-bold text-gray-800 group-hover:text-yellow-600 transition-colors mb-2"
            >
              {{ quiz.name }}
            </h3>
            <p class="text-sm text-gray-500 leading-relaxed mb-3">
              {{ quiz.description }}
            </p>
          </div>
        </div>

        <div
          class="flex items-center justify-between pt-3 border-t border-gray-100"
        >
          <div class="flex gap-2">
            <span
              class="px-3 py-1 bg-blue-50 text-blue-600 text-xs font-bold rounded-full"
            >
              {{ quiz.difficulty }}
            </span>
            <span
              class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-bold rounded-full"
            >
              {{ quiz.count }}ë¬¸ì œ
            </span>
          </div>
          <div class="text-2xl group-hover:scale-110 transition-transform">
            ğŸ“š
          </div>
        </div>
      </div>

      <div
        class="bg-gradient-to-r from-yellow-400 to-yellow-500 py-3 text-center"
      >
        <span class="text-white font-bold text-sm">ì´ ë¬¸ì œì§‘ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-20">
    <div class="text-6xl mb-4">ğŸ“­</div>
    <h3 class="text-2xl font-bold text-gray-800 mb-2">
      ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¸ì œì§‘ì´ ì—†ìŠµë‹ˆë‹¤
    </h3>
    <p class="text-gray-500">quiz_sets í´ë”ì— ë¬¸ì œì§‘ íŒŒì¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
  </div>
  {% endif %}

  <div class="mt-10 text-center">
    <a
      href="/game/goldbell"
      class="inline-block px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-bold"
    >
      â† ëŒì•„ê°€ê¸°
    </a>
  </div>
</div>

<!-- ê²Œì„ ìƒì„± í™•ì¸ ëª¨ë‹¬ -->
<div
  id="confirmModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
    <h3 class="text-2xl font-bold text-gray-800 mb-4">ê²Œì„ ìƒì„± í™•ì¸</h3>
    <p class="text-gray-600 mb-2">ì„ íƒí•œ ë¬¸ì œì§‘:</p>
    <p class="text-xl font-bold text-yellow-600 mb-6" id="selectedQuizName"></p>

    <p class="text-gray-500 text-sm mb-6">
      ê²Œì„ì„ ìƒì„±í•˜ë©´ ì°¸ì—¬ìê°€ ì…ì¥í•  ìˆ˜ ìˆëŠ” ê²Œì„ ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.
    </p>

    <div class="flex gap-3">
      <button
        onclick="closeConfirmModal()"
        class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-bold"
      >
        ì·¨ì†Œ
      </button>
      <button
        onclick="createGame()"
        class="flex-1 px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-bold"
      >
        ê²Œì„ ìƒì„±
      </button>
    </div>
  </div>
</div>

<!-- ë¬¸ì œì§‘ ì¶”ê°€ ëª¨ë‹¬ -->
<div
  id="addQuizModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto"
>
  <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 my-8 shadow-2xl">
    <h3 class="text-3xl font-bold text-green-700 mb-6">ğŸ“š ìƒˆ ë¬¸ì œì§‘ ë§Œë“¤ê¸°</h3>

    <form id="addQuizForm" onsubmit="saveQuiz(event)">
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="bg-gray-50 rounded-xl p-6 mb-6">
        <h4 class="font-bold text-gray-800 mb-4">ê¸°ë³¸ ì •ë³´</h4>

        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2"
            >ë¬¸ì œì§‘ ì´ë¦„ *</label
          >
          <input
            type="text"
            id="quizName"
            required
            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
            placeholder="ì˜ˆ: ì´ˆê¸‰ í•œêµ­ì–´ ë‹¨ì–´"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">ì„¤ëª…</label>
          <textarea
            id="quizDescription"
            rows="2"
            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
            placeholder="ë¬¸ì œì§‘ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
          ></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2"
            >ë‚œì´ë„</label
          >
          <select
            id="quizDifficulty"
            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
          >
            <option value="ì´ˆê¸‰">ì´ˆê¸‰</option>
            <option value="ì¤‘ê¸‰">ì¤‘ê¸‰</option>
            <option value="ê³ ê¸‰">ê³ ê¸‰</option>
          </select>
        </div>
      </div>

      <!-- ë¬¸ì œ ëª©ë¡ -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <h4 class="font-bold text-gray-800">ë¬¸ì œ ëª©ë¡</h4>
          <button
            type="button"
            onclick="addQuestion()"
            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-bold text-sm"
          >
            + ë¬¸ì œ ì¶”ê°€
          </button>
        </div>

        <div id="questionsList" class="space-y-4">
          <!-- ë¬¸ì œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
      </div>

      <div class="flex gap-3 pt-4 border-t">
        <button
          type="button"
          onclick="closeAddQuizModal()"
          class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-bold"
        >
          ì·¨ì†Œ
        </button>
        <button
          type="submit"
          class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-bold"
        >
          ì €ì¥í•˜ê¸°
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let selectedQuizId = null;
  let questionCount = 0;

  function selectQuiz(quizId, quizName) {
    selectedQuizId = quizId;
    document.getElementById("selectedQuizName").textContent = quizName;
    document.getElementById("confirmModal").classList.remove("hidden");
  }

  function closeConfirmModal() {
    document.getElementById("confirmModal").classList.add("hidden");
    selectedQuizId = null;
  }

  function createGame() {
    if (!selectedQuizId) {
      alert("ë¬¸ì œì§‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    // TODO: ì‹¤ì œ ê²Œì„ ìƒì„± API í˜¸ì¶œ
    alert(
      "ë¬¸ì œì§‘: " +
        selectedQuizId +
        "\nê²Œì„ ìƒì„± ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤."
    );
    closeConfirmModal();
  }

  function openAddQuizModal() {
    document.getElementById("addQuizModal").classList.remove("hidden");
    // ì´ˆê¸° ë¬¸ì œ 2ê°œ ì¶”ê°€
    if (questionCount === 0) {
      addQuestion();
      addQuestion();
    }
  }

  function closeAddQuizModal() {
    document.getElementById("addQuizModal").classList.add("hidden");
    // í¼ ì´ˆê¸°í™”
    document.getElementById("addQuizForm").reset();
    document.getElementById("questionsList").innerHTML = "";
    questionCount = 0;
  }

  function addQuestion() {
    questionCount++;
    const questionsList = document.getElementById("questionsList");
    const questionDiv = document.createElement("div");
    questionDiv.className = "bg-white border-2 border-gray-200 rounded-xl p-4";
    questionDiv.id = `question-${questionCount}`;
    questionDiv.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <h5 class="font-bold text-gray-700">ë¬¸ì œ ${questionCount}</h5>
            <button type="button" onclick="removeQuestion(${questionCount})" 
                    class="text-red-500 hover:text-red-700 font-bold text-sm">
                ì‚­ì œ
            </button>
        </div>
        
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-bold text-gray-600 mb-1">ë¬¸ì œ *</label>
                <input type="text" name="question_${questionCount}" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-sm"
                       placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-bold text-green-600 mb-1">ì •ë‹µ *</label>
                    <input type="text" name="answer_${questionCount}" required
                           class="w-full px-3 py-2 border border-green-300 bg-green-50 rounded-lg focus:border-green-500 focus:outline-none text-sm"
                           placeholder="ì •ë‹µ">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">ì˜¤ë‹µ 1 *</label>
                    <input type="text" name="wrong1_${questionCount}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-sm"
                           placeholder="ì˜¤ë‹µ 1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">ì˜¤ë‹µ 2 *</label>
                    <input type="text" name="wrong2_${questionCount}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-sm"
                           placeholder="ì˜¤ë‹µ 2">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">ì˜¤ë‹µ 3 *</label>
                    <input type="text" name="wrong3_${questionCount}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-sm"
                           placeholder="ì˜¤ë‹µ 3">
                </div>
            </div>
        </div>
    `;
    questionsList.appendChild(questionDiv);
  }

  function removeQuestion(id) {
    const questionDiv = document.getElementById(`question-${id}`);
    if (questionDiv) {
      questionDiv.remove();
    }
  }

  async function saveQuiz(event) {
    event.preventDefault();

    const quizName = document.getElementById("quizName").value.trim();
    const quizDescription = document
      .getElementById("quizDescription")
      .value.trim();
    const quizDifficulty = document.getElementById("quizDifficulty").value;

    if (!quizName) {
      alert("ë¬¸ì œì§‘ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    // ëª¨ë“  ë¬¸ì œ ìˆ˜ì§‘
    const questions = [];
    const questionDivs = document.querySelectorAll("#questionsList > div");

    if (questionDivs.length === 0) {
      alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
      return;
    }

    for (let i = 1; i <= questionCount; i++) {
      const questionDiv = document.getElementById(`question-${i}`);
      if (!questionDiv) continue;

      const question = questionDiv
        .querySelector(`input[name="question_${i}"]`)
        .value.trim();
      const answer = questionDiv
        .querySelector(`input[name="answer_${i}"]`)
        .value.trim();
      const wrong1 = questionDiv
        .querySelector(`input[name="wrong1_${i}"]`)
        .value.trim();
      const wrong2 = questionDiv
        .querySelector(`input[name="wrong2_${i}"]`)
        .value.trim();
      const wrong3 = questionDiv
        .querySelector(`input[name="wrong3_${i}"]`)
        .value.trim();

      if (question && answer && wrong1 && wrong2 && wrong3) {
        questions.push({
          question: question,
          answer: answer,
          wrong1: wrong1,
          wrong2: wrong2,
          wrong3: wrong3,
        });
      }
    }

    if (questions.length === 0) {
      alert("ì™„ì„±ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const quizData = {
      quiz_name: quizName,
      quiz_description: quizDescription,
      difficulty: quizDifficulty,
      questions: questions,
    };

    try {
      const response = await fetch("/game/goldbell/save-quiz", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(quizData),
      });

      const result = await response.json();

      if (response.ok) {
        alert("ë¬¸ì œì§‘ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        closeAddQuizModal();
        location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆ ë¬¸ì œì§‘ í‘œì‹œ
      } else {
        alert("ì €ì¥ ì‹¤íŒ¨: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    } catch (error) {
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  async function createGame() {
    if (!selectedQuizId) {
      alert("ë¬¸ì œì§‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const response = await fetch("/game/goldbell/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ quiz_id: selectedQuizId }),
      });

      const result = await response.json();

      if (response.ok) {
        // í˜¸ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `/game/goldbell/host/${result.game_code}`;
      } else {
        alert("ê²Œì„ ìƒì„± ì‹¤íŒ¨: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    } catch (error) {
      alert("ê²Œì„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }
</script>
{% endblock %}
