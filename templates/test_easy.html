{% extends "base.html" %}

{% block title %}ì´ì§€ ëª¨ë“œ ({{ index }}/{{ total }}){% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto py-10 px-4">
    
    <div class="flex justify-between text-sm text-gray-500 mb-2 font-bold">
        <span>Question {{ index }}</span>
        <span>{{ total }}</span>
    </div>
    
    <div class="w-full h-3 bg-gray-200 rounded-full mb-8 overflow-hidden">
        <div class="h-full bg-green-500 transition-all duration-500" style="width: {{ ((index / total) * 100)|int }}%"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-lg border border-green-100 p-8 relative">
        
        <div class="text-center mb-10">
            <h3 class="text-xl md:text-2xl font-bold text-gray-800 break-keep leading-relaxed">
                "{{ question.meaning }}"
            </h3>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for option in options %}
            <button onclick="submitAnswer(this, '{{ option.word }}')" 
                    class="quiz-btn w-full py-4 px-6 rounded-xl border-2 border-gray-100 text-lg font-medium text-gray-600 hover:bg-green-50 hover:border-green-400 transition-all">
                {{ option.word }}
            </button>
            {% endfor %}
        </div>

        <div id="next-btn-area" class="hidden mt-8 text-center">
            <div id="feedback-msg" class="text-xl font-bold mb-4"></div>
            <button id="next-btn" onclick="location.reload()" class="bg-green-600 text-white px-10 py-3 rounded-xl font-bold shadow-md hover:bg-green-700 transition-colors">
                ë‹¤ìŒ ë¬¸ì œ â”
            </button>
        </div>
    </div>
</div>

<script>
    let solved = false;

    function submitAnswer(btn, answer) {
        if (solved) return;
        solved = true;

        // ì„œë²„ì— ì •ë‹µ í™•ì¸ ìš”ì²­
        fetch('/test/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answer: answer })
        })
        .then(res => res.json())
        .then(data => {
            const allBtns = document.querySelectorAll('.quiz-btn');
            const feedback = document.getElementById('feedback-msg');
            const nextBtn = document.getElementById('next-btn');
            
            if (data.correct) {
                btn.classList.remove('border-gray-100');
                btn.classList.add('bg-green-500', 'border-green-500', 'text-white');
                feedback.innerHTML = "<span class='text-green-600'>ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰</span>";
            } else {
                btn.classList.remove('border-gray-100');
                btn.classList.add('bg-red-500', 'border-red-500', 'text-white');
                feedback.innerHTML = `<span class='text-red-500'>ë•¡! ì •ë‹µì€ '${data.answer}'ì…ë‹ˆë‹¤.</span>`;
                
                // ì§„ì§œ ì •ë‹µ ë²„íŠ¼ í‘œì‹œ
                allBtns.forEach(b => {
                    if (b.innerText.trim() === data.answer) {
                        b.classList.remove('border-gray-100');
                        b.classList.add('bg-green-500', 'border-green-500', 'text-white');
                    }
                });
            }
            
            document.getElementById('next-btn-area').classList.remove('hidden');
            
            // [ìˆ˜ì • 2] ë§ˆì§€ë§‰ ë¬¸ì œë©´ ë²„íŠ¼ ë™ì‘ ë³€ê²½ (ë°”ë¡œ ê²°ê³¼ì°½ìœ¼ë¡œ)
            if (data.finished) {
                nextBtn.innerText = "ê²°ê³¼ ë³´ê¸° â”";
                nextBtn.onclick = function() {
                    window.location.href = "/test/result";
                };
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }
</script>
{% endblock %}