{% extends "base.html" %}

{% block title %}ì´ˆì„± í€´ì¦ˆ - ì˜¤ëŸ‰ì–´í•™ì‚¬ì „{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-6 px-4 select-none grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <div class="lg:col-span-2">
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm border border-indigo-100">
            <div class="flex items-center gap-4">
                <div class="text-gray-500 font-bold">SCORE</div>
                <div id="score-display" class="text-3xl font-black text-indigo-600">0</div>
            </div>
            <div class="flex items-center gap-2 w-1/2">
                <span class="text-gray-400 text-sm font-bold">TIME</span>
                <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
                    <div id="time-bar" class="h-full bg-indigo-500 transition-all duration-1000 ease-linear" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="relative w-full h-[500px] bg-white rounded-xl shadow-lg overflow-hidden border-4 border-indigo-50 flex flex-col items-center justify-center p-8 text-center">
            
            <div id="start-overlay" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-indigo-900/90 text-white">
                <div class="text-6xl mb-4">ğŸ•µï¸</div>
                <h1 class="text-4xl font-bold mb-2">ì´ˆì„± í€´ì¦ˆ</h1>
                <p class="text-indigo-200 mb-8">60ì´ˆ ë™ì•ˆ ìµœëŒ€í•œ ë§ì€ ë‹¨ì–´ë¥¼ ë§íˆì„¸ìš”!</p>
                <button onclick="startGame()" class="bg-white text-indigo-900 px-8 py-3 rounded-full font-bold text-xl transition-transform transform hover:scale-105 shadow-lg">
                    ë„ì „ ì‹œì‘
                </button>
            </div>

            <div id="gameover-overlay" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-gray-900/90 text-white backdrop-blur-sm p-6">
                <div class="text-6xl mb-4">â°</div>
                <h2 class="text-3xl font-bold mb-2">TIME OVER</h2>
                <p class="text-xl mb-6">ìµœì¢… ì ìˆ˜: <span id="final-score" class="font-bold text-yellow-300">0</span></p>
                <button onclick="location.reload()" class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold text-lg hover:bg-indigo-700 transition">
                    ë‹¤ì‹œ ë„ì „í•˜ê¸°
                </button>
            </div>

            <div id="quiz-area" class="w-full max-w-lg opacity-0 transition-opacity duration-300">
                <div class="mb-8">
                    <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold">HINT (ëœ»)</span>
                    <h3 id="question-meaning" class="text-xl md:text-2xl font-medium text-gray-700 mt-4 leading-relaxed break-keep">
                        ë¬¸ì œ ëœ»ì´ ì—¬ê¸°ì— ë‚˜ì˜µë‹ˆë‹¤.
                    </h3>
                </div>

                <div class="mb-10">
                    <div id="question-chosung" class="text-6xl md:text-7xl font-black text-indigo-600 tracking-widest">
                        ã… ã„±
                    </div>
                </div>

                <div id="answer-reveal" class="hidden mt-4 animate-bounce">
                    <span class="text-gray-400 text-sm">ì •ë‹µì€</span>
                    <span id="reveal-word" class="text-red-500 text-3xl font-bold ml-2"></span>
                </div>
            </div>
            
            <div id="feedback" class="absolute top-10 right-10 text-6xl opacity-0 transition-opacity duration-500 font-black"></div>

        </div>

        <div class="mt-6 relative flex gap-2">
            <input type="text" id="input-box" 
                class="flex-grow bg-white border-2 border-indigo-200 text-gray-800 text-center text-2xl py-4 rounded-2xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all font-bold shadow-md disabled:bg-gray-100"
                placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off" disabled>
            
            <button onclick="passQuestion()" id="pass-btn" class="bg-gray-200 text-gray-500 px-6 rounded-2xl font-bold hover:bg-gray-300 disabled:opacity-50 transition-colors" disabled>
                PASS<br><span class="text-xs">-2ì´ˆ</span>
            </button>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden h-full max-h-[650px]">
            <div class="bg-indigo-600 p-4 text-white text-center">
                <h3 class="text-xl font-bold">ğŸ† ì´ˆì„±ì™• ë­í‚¹</h3>
                <p class="text-xs text-indigo-100 opacity-80">TOP 10 RANKING</p>
            </div>
            
            <div class="p-4 overflow-y-auto h-full">
                {% if ranking %}
                    <ul class="space-y-2">
                        {% for rank in ranking %}
                        <li class="flex items-center justify-between p-3 rounded-xl {% if loop.index == 1 %}bg-yellow-50 border border-yellow-200{% elif loop.index == 2 %}bg-gray-50 border border-gray-200{% elif loop.index == 3 %}bg-orange-50 border border-orange-200{% else %}bg-white border border-gray-100{% endif %}">
                            <div class="flex items-center gap-3">
                                <span class="font-bold w-6 text-center {% if loop.index <= 3 %}text-xl{% else %}text-gray-400{% endif %}">
                                    {% if loop.index == 1 %}ğŸ¥‡{% elif loop.index == 2 %}ğŸ¥ˆ{% elif loop.index == 3 %}ğŸ¥‰{% else %}{{ loop.index }}{% endif %}
                                </span>
                                <span class="font-medium text-gray-800 truncate max-w-[100px]">{{ rank.name }}</span>
                            </div>
                            <span class="font-bold text-indigo-600">{{ rank.score }}ì </span>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-10 text-gray-400">
                        <p>ì•„ì§ ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    const allWords = {{ all_words|tojson }};
    const currentUser = {{ user|tojson }};
    
    let score = 0;
    let timeLeft = 60;
    let totalTime = 60;
    let timerId;
    let currentQuestion = null;
    let isPlaying = false;
    let isWaiting = false; // ì •ë‹µ ë³´ì—¬ì£¼ëŠ” ì¤‘ì¸ì§€ ì²´í¬

    const inputBox = document.getElementById('input-box');
    const scoreDisplay = document.getElementById('score-display');
    const timeBar = document.getElementById('time-bar');
    const quizArea = document.getElementById('quiz-area');
    const passBtn = document.getElementById('pass-btn');
    const feedback = document.getElementById('feedback');
    const answerReveal = document.getElementById('answer-reveal');
    const revealWord = document.getElementById('reveal-word');

    function startGame() {
        document.getElementById('start-overlay').classList.add('hidden');
        inputBox.disabled = false;
        passBtn.disabled = false;
        inputBox.focus();
        
        score = 0;
        timeLeft = 60;
        isPlaying = true;
        isWaiting = false;
        updateUI();
        
        quizArea.classList.remove('opacity-0');
        
        nextQuestion();
        timerId = setInterval(gameTimer, 1000);
    }

    function gameTimer() {
        if (!isPlaying) return;
        timeLeft--;
        updateUI();
        
        if (timeLeft <= 0) {
            gameOver();
        }
    }

    function nextQuestion() {
        // ì •ë‹µ ê³µê°œì°½ ìˆ¨ê¸°ê¸°
        answerReveal.classList.add('hidden');
        isWaiting = false;
        inputBox.disabled = false;
        inputBox.focus();

        currentQuestion = allWords[Math.floor(Math.random() * allWords.length)];
        
        document.getElementById('question-meaning').innerText = currentQuestion.meaning;
        document.getElementById('question-chosung').innerText = currentQuestion.chosung.split('').join(' ');
    }

    inputBox.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });

    function checkAnswer() {
        if (!isPlaying || isWaiting) return;
        
        const userAns = inputBox.value.trim();
        if (!userAns) return;

        inputBox.value = '';

        if (userAns === currentQuestion.word) {
            // ì •ë‹µ -> ë°”ë¡œ ë‹¤ìŒ ë¬¸ì œ
            score += 10;
            showFeedback('â­•', 'text-green-500');
            nextQuestion();
        } else {
            // ì˜¤ë‹µ -> ì •ë‹µ ë³´ì—¬ì£¼ê³  1.5ì´ˆ ëŒ€ê¸°
            showFeedback('âŒ', 'text-red-500');
            inputBox.classList.add('animate-pulse', 'border-red-400');
            setTimeout(() => inputBox.classList.remove('animate-pulse', 'border-red-400'), 200);
            
            // [ì¶”ê°€ë¨] ì •ë‹µ ê³µê°œ ë¡œì§
            revealWord.innerText = currentQuestion.word;
            answerReveal.classList.remove('hidden');
            
            isWaiting = true; // ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½
            inputBox.disabled = true; // ì…ë ¥ ë§‰ê¸°

            // 1.5ì´ˆ ë’¤ì— ë‹¤ìŒ ë¬¸ì œë¡œ
            setTimeout(() => {
                if (isPlaying) nextQuestion();
            }, 1500);
        }
        
        updateUI();
    }

    function passQuestion() {
        if (!isPlaying || isWaiting) return;
        
        timeLeft = Math.max(0, timeLeft - 2);
        updateUI();
        
        showFeedback('PASS', 'text-gray-400', 'text-2xl');
        
        // íŒ¨ìŠ¤í•  ë•Œë„ ì •ë‹µì„ ì ê¹ ë³´ì—¬ì¤„ê¹Œìš”? ì•„ë‹ˆë©´ ë°”ë¡œ ë„˜ì–´ê°ˆê¹Œìš”?
        // ì—¬ê¸°ì„œëŠ” ë°”ë¡œ ë„˜ì–´ê°€ëŠ” ê±¸ë¡œ ìœ ì§€í•©ë‹ˆë‹¤ (ì†ë„ê° ìœ„í•´)
        nextQuestion();
    }

    function showFeedback(text, colorClass, sizeClass='text-6xl') {
        feedback.innerText = text;
        feedback.className = `absolute top-10 right-10 font-black opacity-100 transition-opacity duration-500 ${colorClass} ${sizeClass}`;
        
        setTimeout(() => {
            feedback.classList.replace('opacity-100', 'opacity-0');
        }, 500);
    }

    function updateUI() {
        scoreDisplay.innerText = score;
        const percent = (timeLeft / totalTime) * 100;
        timeBar.style.width = `${percent}%`;
        
        if (percent < 20) {
            timeBar.classList.replace('bg-indigo-500', 'bg-red-500');
        } else {
            timeBar.classList.replace('bg-red-500', 'bg-indigo-500');
        }
    }

    function gameOver() {
        isPlaying = false;
        clearInterval(timerId);
        inputBox.disabled = true;
        passBtn.disabled = true;
        
        document.getElementById('final-score').innerText = score;
        document.getElementById('gameover-overlay').classList.remove('hidden');

        if (score > 0 && currentUser) {
            saveScore(score);
        }
    }

    function saveScore(finalScore) {
        fetch('/game/consonant/score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ score: finalScore })
        })
        .then(res => res.json())
        .then(data => console.log("Saved"))
        .catch(err => console.error(err));
    }
</script>
{% endblock %}