{% extends "base.html" %}

{% block title %}칼럼 등록{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white border border-gray-200 rounded-2xl shadow-sm p-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <p class="text-sm text-gray-500 font-semibold">관리자 전용</p>
      <h1 class="text-3xl font-bold text-gray-900 mt-1">칼럼 등록</h1>
      <p class="text-sm text-gray-500 mt-2">제목/본문을 작성하고 퀴즈를 추가하세요.</p>
    </div>
    <a href="/column" class="text-sm text-green-600 hover:text-green-700 font-semibold">칼럼 목록</a>
  </div>

  {% if errors %}
  <div class="mb-6 rounded-xl border border-red-200 bg-red-50 text-red-700 px-4 py-3 space-y-1">
    {% for error in errors %}
      <p>• {{ error }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <form id="columnForm" method="POST" class="space-y-6">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">제목</label>
      <input type="text" name="title" required class="w-full rounded-xl border-gray-200 focus:border-green-500 focus:ring-0 px-4 py-3 bg-gray-50" placeholder="예) 한글의 역사" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">본문</label>
      <textarea name="content" rows="8" required class="w-full rounded-xl border-gray-200 focus:border-green-500 focus:ring-0 px-4 py-3 bg-gray-50" placeholder="칼럼 본문을 입력하세요."></textarea>
    </div>

    <div>
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-xl font-bold text-gray-900">퀴즈</h2>
          <p class="text-sm text-gray-500">문항을 추가하고 정답을 선택하세요.</p>
        </div>
        <button type="button" id="addQuestionBtn" class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm font-semibold hover:bg-green-700">문항 추가</button>
      </div>

      <div id="questionsContainer" class="space-y-4"></div>
    </div>

    <input type="hidden" name="quiz_data" id="quizData" />

    <div class="flex gap-3 justify-end">
      <a href="/column" class="px-4 py-3 rounded-xl border border-gray-200 text-gray-700 hover:bg-gray-50 font-medium">취소</a>
      <button type="submit" class="px-5 py-3 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700 shadow-sm">저장</button>
    </div>
  </form>
</div>

<script>
const questionsContainer = document.getElementById('questionsContainer');
const addQuestionBtn = document.getElementById('addQuestionBtn');
const form = document.getElementById('columnForm');
const quizDataInput = document.getElementById('quizData');

function createChoiceInput(qIndex, cIndex, value = '') {
  const wrapper = document.createElement('div');
  wrapper.className = 'flex items-center gap-3';
  wrapper.innerHTML = `
    <input type="radio" name="answer_${qIndex}" value="${cIndex}" class="w-5 h-5 text-green-600 focus:ring-green-500" ${cIndex === 0 ? 'checked' : ''}>
    <input type="text" class="flex-1 rounded-lg border-gray-200 focus:border-green-500 focus:ring-0 px-3 py-2 bg-gray-50" placeholder="보기 ${cIndex + 1}" value="${value}">
  `;
  return wrapper;
}

function createQuestionBlock(initialData = {}) {
  const qIndex = questionsContainer.children.length;
  const block = document.createElement('div');
  block.className = 'question-block bg-gray-50 border-2 border-gray-200 rounded-xl p-4';

  block.innerHTML = `
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-bold text-gray-800">문항 ${qIndex + 1}</h3>
      <button type="button" class="text-sm text-red-500 hover:text-red-600 remove-question">삭제</button>
    </div>
    <div class="space-y-3">
      <input type="text" class="question-text w-full rounded-lg border-gray-200 focus:border-green-500 focus:ring-0 px-3 py-2 bg-white" placeholder="질문을 입력하세요" value="${initialData.question || ''}">
      <textarea class="explanation-text w-full rounded-lg border-blue-100 focus:border-green-500 focus:ring-0 px-3 py-2 bg-blue-50 text-sm" rows="2" placeholder="해설을 입력하세요 (선택)">${initialData.explanation || ''}</textarea>
      <div class="space-y-2 choices"></div>
      <button type="button" class="text-sm text-green-600 hover:text-green-700 add-choice">보기 추가</button>
    </div>
  `;

  const choicesContainer = block.querySelector('.choices');
  const initialChoices = initialData.choices && initialData.choices.length ? initialData.choices : ['', '', '', ''];
  initialChoices.forEach((ch, idx) => {
    choicesContainer.appendChild(createChoiceInput(qIndex, idx, ch));
  });

  block.querySelector('.add-choice').addEventListener('click', () => {
    const currentCount = choicesContainer.children.length;
    choicesContainer.appendChild(createChoiceInput(qIndex, currentCount));
  });

  block.querySelector('.remove-question').addEventListener('click', () => {
    if (questionsContainer.children.length <= 1) {
      alert('최소 1개 이상의 문항이 필요합니다.');
      return;
    }
    block.remove();
  });

  questionsContainer.appendChild(block);
}

addQuestionBtn.addEventListener('click', () => createQuestionBlock());

form.addEventListener('submit', (e) => {
  e.preventDefault();
  const questionBlocks = Array.from(document.querySelectorAll('.question-block'));
  const quiz = [];

  for (const [idx, block] of questionBlocks.entries()) {
    const questionText = block.querySelector('.question-text').value.trim();
    const explanationText = block.querySelector('.explanation-text').value.trim();
    const choiceInputs = Array.from(block.querySelectorAll('.choices input[type="text"]'));
    const answerRadio = block.querySelector(`input[name="answer_${idx}"]:checked`);
    const choices = choiceInputs.map(inp => inp.value.trim()).filter(v => v !== '');

    if (!questionText) {
      alert(`문항 ${idx + 1}의 질문을 입력해주세요.`);
      return;
    }
    if (choices.length < 2) {
      alert(`문항 ${idx + 1}의 보기 두 개 이상을 입력해주세요.`);
      return;
    }
    if (!answerRadio || parseInt(answerRadio.value, 10) >= choices.length) {
      alert(`문항 ${idx + 1}의 정답을 다시 선택해주세요.`);
      return;
    }

    quiz.push({
      question: questionText,
      choices: choices,
      answer: parseInt(answerRadio.value, 10),
      explanation: explanationText
    });
  }

  quizDataInput.value = JSON.stringify(quiz);
  form.submit();
});

// 기본 1문항 생성
createQuestionBlock();
</script>
{% endblock %}
