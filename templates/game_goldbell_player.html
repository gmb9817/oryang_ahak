{% extends "base.html" %}

{% block title %}ëŒ€ê¸°ì‹¤ - ê³¨ë“ ë²¨{% endblock %}

{% block content %}

{% if game.status == 'waiting' %}
<!-- ëŒ€ê¸°ì‹¤ -->
<div class="max-w-4xl mx-auto py-12 px-4 text-center">
    
    <!-- ê²Œì„ ì •ë³´ -->
    <div class="mb-10">
        <div class="text-6xl mb-4">ğŸ®</div>
        <h2 class="text-3xl font-bold text-yellow-600 mb-3">{{ game.quiz_name }}</h2>
        <p class="text-gray-600 text-lg">ê²Œì„ ì½”ë“œ: <span class="font-bold text-2xl text-yellow-600">{{ game.code }}</span></p>
    </div>

    <!-- ëŒ€ê¸° ìƒíƒœ -->
    <div class="bg-white rounded-2xl shadow-lg p-12 mb-8">
        <div class="animate-pulse">
            <div class="text-7xl mb-6">â³</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</h3>
            <p class="text-gray-500 mb-6">
                ë‹¤ë¥¸ ì°¸ì—¬ìë“¤ì´ ì…ì¥í•  ë•Œê¹Œì§€ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
            </p>
        </div>
    </div>

    <!-- ì°¸ì—¬ì ìˆ˜ -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
        <p class="text-gray-600 mb-2">í˜„ì¬ ì°¸ì—¬ ì¸ì›</p>
        <p class="text-4xl font-bold text-indigo-600" id="playerCount">{{ game.players|length }}ëª…</p>
    </div>

    <div class="mt-8">
        <a href="/game/goldbell" class="inline-block px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-bold">
            ë‚˜ê°€ê¸°
        </a>
    </div>

</div>

<script>
setInterval(() => {
    location.reload();
}, 3000);
</script>

{% elif game.status == 'intro' %}
<!-- ì‹œì‘ í™”ë©´ -->
<div class="fixed inset-0 bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center">
    <div class="text-center text-white">
        <div class="text-8xl mb-8">ğŸ””</div>
        <h1 class="text-6xl font-bold mb-4">ê²Œì„ ì‹œì‘!</h1>
        <p class="text-2xl mb-8">{{ game.quiz_name }}</p>
        <div class="text-xl">ì¤€ë¹„í•˜ì„¸ìš”...</div>
    </div>
</div>

<script>
setInterval(() => {
    location.reload();
}, 2000);
</script>

{% elif game.status == 'playing' %}
<!-- ë¬¸ì œ í’€ê¸° í™”ë©´ -->
{% set question = game.questions[game.current_question] %}

<div class="fixed inset-0 bg-gray-900 flex flex-col">
    
    <!-- ìƒë‹¨ ì •ë³´ -->
    <div class="bg-gray-800 px-6 py-4 flex items-center justify-between">
        <div class="text-white font-bold text-lg">
            ë¬¸ì œ {{ game.current_question + 1 }} / {{ game.questions|length }}
        </div>
        <div class="text-white font-bold text-lg" id="timer">
            â±ï¸ <span id="timeLeft">30</span>ì´ˆ
        </div>
    </div>
    
    <!-- ë¬¸ì œ -->
    <div class="bg-gray-800 p-6 text-center">
        <h2 class="text-2xl font-bold text-white leading-tight">
            {{ question.question }}
        </h2>
    </div>
    
    <!-- ì„ íƒì§€ (4ê°œ, 2x2 ê·¸ë¦¬ë“œ) -->
    <div class="flex-1 p-4 grid grid-cols-2 gap-4" id="choicesContainer">
        {% if shuffled_choices %}
            {% for choice in shuffled_choices %}
            {% set colors = {
                'red': {'bg': 'bg-red-500', 'hover': 'hover:bg-red-600'},
                'blue': {'bg': 'bg-blue-500', 'hover': 'hover:bg-blue-600'},
                'yellow': {'bg': 'bg-yellow-500', 'hover': 'hover:bg-yellow-600'},
                'green': {'bg': 'bg-green-500', 'hover': 'hover:bg-green-600'}
            } %}
            <button onclick="submitAnswer('{{ choice.text }}')" 
                    class="choice-btn {{ colors[choice.color].bg }} {{ colors[choice.color].hover }} text-white rounded-2xl shadow-2xl transition-all transform hover:scale-105 flex items-center justify-center p-8"
                    data-answer="{{ choice.text }}">
                <span class="text-3xl font-bold text-center">{{ choice.text }}</span>
            </button>
            {% endfor %}
        {% endif %}
    </div>
</div>

<script>
const gameCode = "{{ game.code }}";
let timeLeft = 30;
let timerInterval;
let answered = false;

// íƒ€ì´ë¨¸ ì‹œì‘
timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById('timeLeft').textContent = timeLeft;
    
    if (timeLeft <= 0) {
        clearInterval(timerInterval);
        if (!answered) {
            disableChoices();
            showMessage('ì‹œê°„ ì´ˆê³¼!', 'bg-red-500');
        }
    }
}, 1000);

async function submitAnswer(answer) {
    if (answered) return;
    answered = true;
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    disableChoices();
    
    try {
        const response = await fetch(`/game/goldbell/submit/${gameCode}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ answer: answer })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            clearInterval(timerInterval);
            
            if (result.correct) {
                showMessage(`ì •ë‹µ! +${result.score}ì `, 'bg-green-500');
            } else {
                showMessage(`ì˜¤ë‹µ! ì •ë‹µ: ${result.correct_answer}`, 'bg-red-500');
            }
            
            // 3ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œ ëŒ€ê¸°
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            alert('ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            answered = false;
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        answered = false;
    }
}

function disableChoices() {
    const buttons = document.querySelectorAll('.choice-btn');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.classList.remove('hover:scale-105');
        btn.classList.add('opacity-50', 'cursor-not-allowed');
    });
}

function showMessage(message, bgClass) {
    const container = document.getElementById('choicesContainer');
    container.innerHTML = `
        <div class="col-span-2 flex items-center justify-center">
            <div class="${bgClass} text-white rounded-2xl p-12 text-center">
                <p class="text-5xl font-bold">${message}</p>
            </div>
        </div>
    `;
}

// ê²Œì„ ìƒíƒœ í™•ì¸ (ë¬¸ì œê°€ ë„˜ì–´ê°”ëŠ”ì§€)
setInterval(() => {
    if (!answered) {
        fetch(`/game/goldbell/status/${gameCode}`)
            .then(res => res.json())
            .then(data => {
                if (data.current_question !== {{ game.current_question }}) {
                    location.reload();
                }
            });
    }
}, 2000);
</script>

{% elif game.status == 'finished' %}
<!-- ê²Œì„ ì¢…ë£Œ -->
<div class="max-w-4xl mx-auto py-12 px-4 text-center">
    <div class="text-8xl mb-8">ğŸ‰</div>
    <h2 class="text-4xl font-bold text-yellow-600 mb-8">ê²Œì„ ì¢…ë£Œ!</h2>
    
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">ìµœì¢… ê²°ê³¼</h3>
        
        {% for player in game.players %}
            {% if player.name == user.name %}
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-8 text-white mb-6">
                <p class="text-lg mb-2">ë‚´ ì ìˆ˜</p>
                <p class="text-6xl font-bold">{{ player.score }}ì </p>
            </div>
            {% endif %}
        {% endfor %}
        
        <p class="text-gray-600">
            ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!
        </p>
    </div>
    
    <a href="/game/goldbell" class="inline-block px-8 py-4 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-bold text-xl">
        ê³¨ë“ ë²¨ ë©”ì¸ìœ¼ë¡œ
    </a>
</div>

{% endif %}

{% endblock %}
