{% extends "base.html" %} {% block title %}ê²Œì„ ëŒ€ê¸°ì‹¤ - ê³¨ë“ ë²¨{% endblock %} {%
block content %} {% if game.status == 'waiting' %}
<!-- ëŒ€ê¸°ì‹¤ -->
<div class="max-w-6xl mx-auto py-12 px-4">
  <!-- ê²Œì„ ì½”ë“œ í‘œì‹œ -->
  <div class="text-center mb-10">
    <h2 class="text-3xl font-bold text-yellow-600 mb-4">
      ğŸ”” {{ game.quiz_name }}
    </h2>
    <div
      class="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-2xl p-8 shadow-2xl mb-4"
    >
      <p class="text-white text-lg mb-2 font-bold">ê²Œì„ ì½”ë“œ</p>
      <p class="text-white text-7xl font-bold tracking-widest" id="gameCode">
        {{ game.code }}
      </p>
      <p class="text-yellow-100 text-sm mt-4">
        ì°¸ì—¬ìë“¤ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”
      </p>
    </div>

    <div class="flex gap-4 justify-center">
      <button
        onclick="copyGameCode()"
        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-bold"
      >
        ğŸ“‹ ì½”ë“œ ë³µì‚¬
      </button>
      <button
        onclick="startGame()"
        class="px-8 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-bold text-lg"
      >
        ğŸ® ê²Œì„ ì‹œì‘
      </button>
    </div>
  </div>

  <!-- ì°¸ì—¬ì ëª©ë¡ -->
  <div class="bg-white rounded-2xl shadow-lg p-8">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-gray-800">
        ì°¸ì—¬ì (<span id="playerCount">{{ game.players|length }}</span>ëª…)
      </h3>
      <button
        onclick="refreshPlayers()"
        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-bold text-sm"
      >
        ğŸ”„ ìƒˆë¡œê³ ì¹¨
      </button>
    </div>

    <div
      id="playersList"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
    >
      {% if game.players %} {% for player in game.players %}
      <div
        class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl border border-gray-200"
      >
        <img
          src="{{ player.picture }}"
          alt="{{ player.name }}"
          class="w-12 h-12 rounded-full border-2 border-green-400"
        />
        <div>
          <p class="font-bold text-gray-800">{{ player.name }}</p>
          <p class="text-xs text-gray-500">ë°©ê¸ˆ ì°¸ì—¬í•¨</p>
        </div>
      </div>
      {% endfor %} {% else %}
      <div class="col-span-full text-center py-12 text-gray-400">
        <div class="text-5xl mb-3">ğŸ‘¥</div>
        <p>ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        <p class="text-sm mt-2">ê²Œì„ ì½”ë“œë¥¼ ê³µìœ í•˜ì—¬ ì°¸ì—¬ìë¥¼ ì´ˆëŒ€í•˜ì„¸ìš”!</p>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="mt-8 text-center">
    <a
      href="/game/goldbell/create"
      class="inline-block px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-bold"
    >
      â† ë¬¸ì œì§‘ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
    </a>
  </div>
</div>

{% elif game.status == 'intro' %}
<!-- ì‹œì‘ í™”ë©´ -->
<div
  class="fixed inset-0 bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center"
>
  <div class="text-center text-white">
    <div class="text-8xl mb-8">ğŸ””</div>
    <h1 class="text-6xl font-bold mb-4">ê³¨ë“ ë²¨ì´ ìš¸ë¦½ë‹ˆë‹¤!</h1>
    <p class="text-2xl mb-8">{{ game.quiz_name }}</p>
    <div class="text-xl">ì ì‹œ í›„ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤...</div>
  </div>
</div>

<script>
  setTimeout(() => {
    nextQuestion();
  }, 3000);
</script>

{% elif game.status == 'playing' %}
<!-- ë¬¸ì œ í‘œì‹œ í™”ë©´ -->
{% set question = game.questions[game.current_question] %}
<div
  class="fixed inset-0 bg-gradient-to-br from-blue-500 to-purple-600 flex flex-col"
>
  <!-- ìƒë‹¨ ì •ë³´ -->
  <div
    class="bg-white bg-opacity-20 backdrop-blur px-8 py-4 flex items-center justify-between"
  >
    <div class="text-white font-bold text-xl">
      ë¬¸ì œ {{ game.current_question + 1 }} / {{ game.questions|length }}
    </div>
    <div class="text-white font-bold text-xl">
      ì°¸ì—¬ì: {{ game.players|length }}ëª…
    </div>
  </div>

  <!-- ë¬¸ì œ -->
  <div class="flex-1 flex items-center justify-center p-12">
    <div class="text-center max-w-4xl">
      <div class="text-7xl mb-8">â“</div>
      <h2 class="text-5xl font-bold text-white mb-12 leading-tight">
        {{ question.question }}
      </h2>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë²„íŠ¼ -->
  <div class="p-8 text-center">
    <button
      onclick="showAnswers()"
      class="px-8 py-4 bg-white text-blue-600 rounded-xl hover:bg-gray-100 transition-colors font-bold text-xl shadow-2xl"
    >
      ì •ë‹µ ê³µê°œ â†’
    </button>
  </div>
</div>

<script>
  const question = {{ question | tojson }};

  function showAnswers() {
      // ì •ë‹µ ê³µê°œ ë° ë‹¤ìŒ ë¬¸ì œë¡œ
      if (confirm('ì •ë‹µì„ ê³µê°œí•˜ê³  ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          nextQuestion();
      }
  }
</script>

{% elif game.status == 'finished' %}
<!-- ê²Œì„ ì¢…ë£Œ -->
<div class="max-w-4xl mx-auto py-12 px-4 text-center">
  <div class="text-8xl mb-8">ğŸ†</div>
  <h2 class="text-4xl font-bold text-yellow-600 mb-8">ê²Œì„ ì¢…ë£Œ!</h2>

  <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
    <h3 class="text-2xl font-bold text-gray-800 mb-6">ìµœì¢… ìˆœìœ„</h3>

    {% set sorted_players = game.players | sort(attribute='score', reverse=True)
    %}
    <div class="space-y-4">
      {% for player in sorted_players %}
      <div
        class="flex items-center justify-between p-4 bg-gray-50 rounded-xl {% if loop.index == 1 %}border-4 border-yellow-400{% endif %}"
      >
        <div class="flex items-center gap-4">
          <div
            class="text-3xl font-bold {% if loop.index == 1 %}text-yellow-500{% elif loop.index == 2 %}text-gray-400{% elif loop.index == 3 %}text-orange-600{% else %}text-gray-600{% endif %}"
          >
            #{{ loop.index }}
          </div>
          <img
            src="{{ player.picture }}"
            alt="{{ player.name }}"
            class="w-12 h-12 rounded-full"
          />
          <div class="text-left">
            <p class="font-bold text-gray-800">{{ player.name }}</p>
          </div>
        </div>
        <div class="text-3xl font-bold text-blue-600">{{ player.score }}ì </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <a
    href="/game/goldbell/create"
    class="inline-block px-8 py-4 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-bold text-xl"
  >
    ìƒˆ ê²Œì„ ì‹œì‘
  </a>
</div>

{% endif %}

<script>
  const gameCode = "{{ game.code }}";

  function copyGameCode() {
    navigator.clipboard
      .writeText(gameCode)
      .then(() => {
        alert("ê²Œì„ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + gameCode);
      })
      .catch((err) => {
        alert("ë³µì‚¬ ì‹¤íŒ¨: " + err);
      });
  }

  function refreshPlayers() {
    location.reload();
  }

  async function startGame() {
    const playerCount = parseInt(
      document.getElementById("playerCount").textContent
    );

    if (playerCount === 0) {
      alert("ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤. ìµœì†Œ 1ëª… ì´ìƒì˜ ì°¸ì—¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    if (confirm(`${playerCount}ëª…ì˜ ì°¸ì—¬ìì™€ í•¨ê»˜ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      try {
        const response = await fetch(`/game/goldbell/begin/${gameCode}`, {
          method: "POST",
        });

        const result = await response.json();

        if (response.ok) {
          // ê²Œì„ ì‹œì‘ í™”ë©´ìœ¼ë¡œ ì „í™˜
          showIntro();
        } else {
          alert("ê²Œì„ ì‹œì‘ ì‹¤íŒ¨: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      } catch (error) {
        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
      }
    }
  }

  function showIntro() {
    // ì¸íŠ¸ë¡œ í™”ë©´ í‘œì‹œ í›„ ì²« ë¬¸ì œë¡œ ì´ë™
    document.body.innerHTML = `
        <div class="fixed inset-0 bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center">
            <div class="text-center text-white">
                <div class="text-8xl mb-8">ğŸ””</div>
                <h1 class="text-6xl font-bold mb-4">ê³¨ë“ ë²¨ì´ ìš¸ë¦½ë‹ˆë‹¤!</h1>
                <p class="text-2xl mb-8">{{ game.quiz_name }}</p>
                <div class="text-xl">ì ì‹œ í›„ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤...</div>
            </div>
        </div>
    `;

    setTimeout(() => {
      nextQuestion();
    }, 3000);
  }

  async function nextQuestion() {
    try {
      const response = await fetch(`/game/goldbell/next/${gameCode}`, {
        method: "POST",
      });

      const result = await response.json();

      if (response.ok) {
        if (result.finished) {
          // ê²Œì„ ì¢…ë£Œ
          location.href = `/game/goldbell/host/${gameCode}`;
          location.reload();
        } else {
          // ë¬¸ì œ í‘œì‹œ í™”ë©´ìœ¼ë¡œ ì´ë™
          location.reload();
        }
      } else {
        alert("ì˜¤ë¥˜: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    } catch (error) {
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  // ìë™ ìƒˆë¡œê³ ì¹¨ (5ì´ˆë§ˆë‹¤) - ëŒ€ê¸° ì¤‘ì¼ ë•Œë§Œ
  if ("{{ game.status }}" === "waiting") {
    setInterval(() => {
      refreshPlayers();
    }, 5000);
  }
</script>
{% endblock %}
